

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ckan_api_client.tests.conftest &mdash; Ckan API client 0.1a documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../../../',
        VERSION:'0.1a',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="Ckan API client 0.1a documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="icon icon-home"> Ckan API client</a>
        <form class="wy-form" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../clients/index.html">Clients</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/low-level.html">Low-level</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/high-level.html">High-level</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/syncing.html">Syncing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/exceptions.html">ckan_api_client.exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/objects.html">ckan_api_client.objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/utils.html">ckan_api_client.utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/index.html">Testing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../testing/fixtures.html">Fixtures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing/utility.html">Testing utilities</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">Ckan API client</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="../../../index.html">Docs</a> &raquo;</li>
  <li><a href="">ckan_api_client.tests.conftest</a></li>
  
</ul>
<hr/>

          
  <h1>Source code for ckan_api_client.tests.conftest</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">ConfigParser</span> <span class="kn">import</span> <span class="n">RawConfigParser</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urlparse</span>

<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extras</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">solr</span>

<span class="n">HERE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>


<span class="c">## Paster command to create users:</span>
<span class="c"># paster --plugin=ckan user --config=$VIRTUAL_ENV/etc/ckan/production.ini</span>
<span class="c"># add admin password=admin email=admin@example.com api-key=my-api-key</span>

<span class="c">## Paster command to initialize database</span>
<span class="c"># paster --plugin=ckan db --config=$VIRTUAL_ENV/etc/ckan.ini init</span>

<span class="c">## Paster command to rebuild search index</span>
<span class="c"># paster --plugin=ckan search-index --config=$VIRTUAL_ENV/etc/ckan.ini rebuild</span>

<span class="c">## Paster command to run server</span>
<span class="c"># paster --plugin=ckan serve $VIRTUAL_ENV/etc/ckan.ini</span>


<div class="viewcode-block" id="check_tcp_port"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.check_tcp_port">[docs]</a><span class="k">def</span> <span class="nf">check_tcp_port</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether a given TCP port is reachable&quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="wait_net_service"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.wait_net_service">[docs]</a><span class="k">def</span> <span class="nf">wait_net_service</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wait for network service to appear</span>

<span class="sd">    Based on: http://code.activestate.com/recipes/576655/</span>

<span class="sd">    :param timeout: in seconds</span>
<span class="sd">    :return: True of False, if timeout is None may return only True or</span>
<span class="sd">             throw unhandled network exception</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">socket</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">next_timeout</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">next_timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Timed out&quot;</span><span class="p">)</span>

            <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">next_timeout</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c"># Keep suppressing exceptions</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Connection successful!</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="discover_available_port"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.discover_available_port">[docs]</a><span class="k">def</span> <span class="nf">discover_available_port</span><span class="p">(</span><span class="n">minport</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">maxport</span><span class="o">=</span><span class="mi">9000</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">portnum</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">minport</span><span class="p">,</span> <span class="n">maxport</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tcp_port</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">portnum</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">portnum</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;No available port in range!&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="CkanEnvironment"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment">[docs]</a><span class="k">class</span> <span class="nc">CkanEnvironment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class providing functionality to manage a Ckan installation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CkanEnvironment.__init__"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">venv_root</span><span class="p">,</span> <span class="n">pgsql_admin_url</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param venv_root:</span>
<span class="sd">            Root path to the virtualenv in which Ckan is installed</span>
<span class="sd">        :param pgsql_admin_url:</span>
<span class="sd">            URL with administrative credentials to PostgreSQL</span>
<span class="sd">        :param solr_url:</span>
<span class="sd">            URL to Solr index to be used</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">venv_root</span> <span class="o">=</span> <span class="n">venv_root</span>

        <span class="c">## This will be generated temporarily</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_admin_url</span> <span class="o">=</span> <span class="n">pgsql_admin_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr_url</span> <span class="o">=</span> <span class="n">solr_url</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="CkanEnvironment.from_environment"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.from_environment">[docs]</a>    <span class="k">def</span> <span class="nf">from_environment</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alternate constructor: initializes configuration</span>
<span class="sd">        by reading environment variables.</span>

<span class="sd">        - ``CKAN_VIRTUALENV`` will be used as the virtualenv</span>
<span class="sd">          in which Ckan is installed (may differ from current</span>
<span class="sd">          virtualenv!).</span>
<span class="sd">        - ``CKAN_POSTGRES_ADMIN`` url with administrative</span>
<span class="sd">          credentials to be used to access PostgreSQL.</span>
<span class="sd">          Example: ``postgresql://postgres:pass@localhost/postgres``</span>
<span class="sd">        - ``SOLR_URL`` url of the solr index to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">venv_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;CKAN_VIRTUALENV&#39;</span><span class="p">]</span>
        <span class="n">pgsql_admin_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;CKAN_POSTGRES_ADMIN&#39;</span><span class="p">]</span>
        <span class="n">solr_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;CKAN_SOLR&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">venv_root</span><span class="p">,</span> <span class="n">pgsql_admin_url</span><span class="p">,</span> <span class="n">solr_url</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.get_conf_parser"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.get_conf_parser">[docs]</a>    <span class="k">def</span> <span class="nf">get_conf_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a RawConfigParser instance, associated with the main</span>
<span class="sd">        Ckan configuration file.</span>

<span class="sd">        Not caching this as we want to reload any changes that should</span>
<span class="sd">        have occurred on the file..</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cfp</span> <span class="o">=</span> <span class="n">RawConfigParser</span><span class="p">()</span>
        <span class="n">cfp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cfp</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.conf_set"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.conf_set">[docs]</a>    <span class="k">def</span> <span class="nf">conf_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a configuration option in the main Ckan configuration&quot;&quot;&quot;</span>
        <span class="n">conf_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conf_parser</span><span class="p">()</span>
        <span class="n">conf_parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">conf_parser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.conf_get"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.conf_get">[docs]</a>    <span class="k">def</span> <span class="nf">conf_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a configuration option from the main Ckan configuration&quot;&quot;&quot;</span>
        <span class="n">conf_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conf_parser</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">conf_parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.conf_del"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.conf_del">[docs]</a>    <span class="k">def</span> <span class="nf">conf_del</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a configuration option from the main Ckan configuration&quot;&quot;&quot;</span>
        <span class="n">conf_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conf_parser</span><span class="p">()</span>
        <span class="n">conf_parser</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
        <span class="n">conf_parser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.conf_update"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.conf_update">[docs]</a>    <span class="k">def</span> <span class="nf">conf_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update main Ckan configuration.</span>

<span class="sd">        :param dict data: dict of dicts, section/option/value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conf_parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conf_parser</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">sdata</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sdata</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">conf_parser</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">conf_parser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.get_postgres_admin_connection"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.get_postgres_admin_connection">[docs]</a>    <span class="k">def</span> <span class="nf">get_postgres_admin_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: administrative connection to database</span>
<span class="sd">        :rtype: psycopg2.connect()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_port</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_admin_user</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_admin_password</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="s">&#39;postgres&#39;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.get_postgres_connection"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.get_postgres_connection">[docs]</a>    <span class="k">def</span> <span class="nf">get_postgres_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: &quot;user&quot; connection to database</span>
<span class="sd">        :rtype: psycopg2.connect()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_port</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_user</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_password</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_db_name</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.create_db_user"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.create_db_user">[docs]</a>    <span class="k">def</span> <span class="nf">create_db_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create PostgreSQL user, for use by Ckan&quot;&quot;&quot;</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_admin_connection</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        CREATE ROLE {0} LOGIN</span>
<span class="s">        PASSWORD &#39;{1}&#39;</span>
<span class="s">        NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION;</span>
<span class="s">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_password</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.create_db"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.create_db">[docs]</a>    <span class="k">def</span> <span class="nf">create_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create PostgreSQL database, for use by Ckan&quot;&quot;&quot;</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_admin_connection</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        CREATE DATABASE {0}</span>
<span class="s">          WITH OWNER = {1}</span>
<span class="s">               ENCODING = &#39;UTF8&#39;</span>
<span class="s">               TABLESPACE = pg_default</span>
<span class="s">               LC_COLLATE = &#39;en_US.UTF-8&#39;</span>
<span class="s">               LC_CTYPE = &#39;en_US.UTF-8&#39;</span>
<span class="s">               CONNECTION LIMIT = -1;</span>
<span class="s">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_db_name</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_user</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.drop_db_user"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.drop_db_user">[docs]</a>    <span class="k">def</span> <span class="nf">drop_db_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete previously created PostgreSQL user, to cleanup</span>
<span class="sd">        after running tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_admin_connection</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DROP ROLE {0};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_user</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.drop_db"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.drop_db">[docs]</a>    <span class="k">def</span> <span class="nf">drop_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete previously created PostgreSQL database, to cleanup</span>
<span class="sd">        after running tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_admin_connection</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DROP DATABASE {0};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_db_name</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.flush_solr_index"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.flush_solr_index">[docs]</a>    <span class="k">def</span> <span class="nf">flush_solr_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Completely flush the configured Solr index.</span>

<span class="sd">        .. note:: since Ckan supports sharing the same index between</span>
<span class="sd">                  installations, we don&#39;t actually delete *everything*</span>
<span class="sd">                  from the index, but instead issued a delete on query:</span>
<span class="sd">                  ``+site_id:&quot;&lt;ckan-site-id&gt;&quot;``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">solr</span><span class="o">.</span><span class="n">SolrConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solr_url</span><span class="p">)</span>
        <span class="c">#query = &#39;*:*&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;+site_id:&quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">delete_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">numFound</span> <span class="o">==</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.run_paster"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.run_paster">[docs]</a>    <span class="k">def</span> <span class="nf">run_paster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a paster command in the virtualenv.</span>

<span class="sd">        Arguments will be passed to the paster command invocation.</span>

<span class="sd">        Executed command will be something like::</span>

<span class="sd">            &lt;venv&gt;/bin/python &lt;venv&gt;/bin/paster --plugin=ckan [&lt;args&gt; ..]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">python</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_root</span><span class="p">,</span> <span class="s">&#39;bin&#39;</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">)</span>
        <span class="n">paster</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_root</span><span class="p">,</span> <span class="s">&#39;bin&#39;</span><span class="p">,</span> <span class="s">&#39;paster&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">((</span><span class="n">python</span><span class="p">,</span> <span class="n">paster</span><span class="p">,</span> <span class="s">&#39;--plugin=ckan&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.run_paster_with_conf"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.run_paster_with_conf">[docs]</a>    <span class="k">def</span> <span class="nf">run_paster_with_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a paster command in the virtualenv, adding --config=ckan.ini</span>

<span class="sd">        :param command: the paster command to be run</span>
<span class="sd">        :param args: other arguments will be passed to the command</span>

<span class="sd">        Executed command will be something like::</span>

<span class="sd">            &lt;venv&gt;/bin/python &lt;venv&gt;/bin/paster --plugin=ckan \\</span>
<span class="sd">                &lt;command&gt; --config=&lt;venv&gt;/etc/ckan/ckan.ini [&lt;args&gt; ..]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_paster</span><span class="p">(</span>
            <span class="n">command</span><span class="p">,</span> <span class="s">&#39;--config={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.serve"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.serve">[docs]</a>    <span class="k">def</span> <span class="nf">serve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the Ckan server, using ``paster serve`` command.</span>

<span class="sd">        :rtype: :py:class:`CkanServerWrapper`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">python</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_root</span><span class="p">,</span> <span class="s">&#39;bin&#39;</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">)</span>
        <span class="n">paster</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_root</span><span class="p">,</span> <span class="s">&#39;bin&#39;</span><span class="p">,</span> <span class="s">&#39;paster&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">CkanServerWrapper</span><span class="p">([</span>
            <span class="n">python</span><span class="p">,</span> <span class="n">paster</span><span class="p">,</span> <span class="s">&#39;serve&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span>
        <span class="p">],</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.paster_db_init"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.paster_db_init">[docs]</a>    <span class="k">def</span> <span class="nf">paster_db_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize database, by calling paster command&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_paster_with_conf</span><span class="p">(</span><span class="s">&#39;db&#39;</span><span class="p">,</span> <span class="s">&#39;init&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.paster_search_index_rebuild"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.paster_search_index_rebuild">[docs]</a>    <span class="k">def</span> <span class="nf">paster_search_index_rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rebuild search index, by calling paster command&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_paster_with_conf</span><span class="p">(</span><span class="s">&#39;search-index&#39;</span><span class="p">,</span> <span class="s">&#39;rebuild&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.paster_user_add"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.paster_user_add">[docs]</a>    <span class="k">def</span> <span class="nf">paster_user_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create Ckan user, by calling paster command&quot;&quot;&quot;</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;{0}={1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_paster_with_conf</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">,</span> <span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="c"># todo: retrieve user from database</span>
        <span class="c"># select name, apikey from &quot;user&quot; where name=&#39;&#39;;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_connection</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT &quot;name&quot;, &quot;apikey&quot; FROM &quot;user&quot; WHERE name=</span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s">&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.paster_user_remove"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.paster_user_remove">[docs]</a>    <span class="k">def</span> <span class="nf">paster_user_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove Ckan user, by calling paster command&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_paster_with_conf</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">,</span> <span class="s">&#39;remove&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.paster_sysadmin_add"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.paster_sysadmin_add">[docs]</a>    <span class="k">def</span> <span class="nf">paster_sysadmin_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Grant sysadmin privileges to a Ckan user,</span>
<span class="sd">        by calling paster command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_paster_with_conf</span><span class="p">(</span><span class="s">&#39;sysadmin&#39;</span><span class="p">,</span> <span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.paster_sysadmin_remove"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.paster_sysadmin_remove">[docs]</a>    <span class="k">def</span> <span class="nf">paster_sysadmin_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Revoke sysadmin privileges from a Ckan user,</span>
<span class="sd">        by calling paster command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_paster_with_conf</span><span class="p">(</span><span class="s">&#39;sysadmin&#39;</span><span class="p">,</span> <span class="s">&#39;remove&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.get_sysadmin_api_key"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.get_sysadmin_api_key">[docs]</a>    <span class="k">def</span> <span class="nf">get_sysadmin_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a sysadmin user (with random name / password)</span>
<span class="sd">        and return its API key.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">ckan_api_client.tests.utils.strings</span> \
            <span class="kn">import</span> <span class="p">(</span><span class="n">generate_password</span><span class="p">,</span> <span class="n">generate_random_alphanum</span><span class="p">)</span>

        <span class="n">user_name</span> <span class="o">=</span> <span class="s">&#39;api_test_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">generate_random_alphanum</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paster_user_add</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="n">generate_password</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
            <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="s">&#39;{0}@example.com&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_name</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paster_sysadmin_add</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user_data</span><span class="p">[</span><span class="s">&#39;apikey&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.setup"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called by :py:meth:`__init__` to setup things.&quot;&quot;&quot;</span>
        <span class="c">## Prepare IDs &amp; names</span>
        <span class="n">my_id</span> <span class="o">=</span> <span class="s">&#39;{0:06d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">))</span>

        <span class="c">## Configuration file</span>
        <span class="n">conf_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">venv_root</span><span class="p">,</span> <span class="s">&#39;etc&#39;</span><span class="p">,</span> <span class="s">&#39;ckan&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">conf_dir</span><span class="p">,</span> <span class="s">&#39;ckan-{0}.ini&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">my_id</span><span class="p">))</span>
        <span class="c">## Note: containing directory is created later</span>

        <span class="c">## Storage path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">venv_root</span><span class="p">,</span> <span class="s">&#39;var&#39;</span><span class="p">,</span> <span class="s">&#39;lib&#39;</span><span class="p">,</span> <span class="s">&#39;ckan-{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">my_id</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="p">)</span>

        <span class="c">## Port on which server will listen</span>
        <span class="c">#self.server_port = self.get_ephemeral_port()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="n">discover_available_port</span><span class="p">()</span>

        <span class="n">parsed_pg_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_admin_url</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">parsed_pg_url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s">&#39;postgresql&#39;</span>
        <span class="n">credentials</span><span class="p">,</span> <span class="n">host</span> <span class="o">=</span> <span class="n">parsed_pg_url</span><span class="o">.</span><span class="n">netloc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postgresql_admin_user</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_admin_password</span><span class="p">)</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">host</span><span class="p">:</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="mi">5432</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_port</span> <span class="o">=</span> <span class="n">port</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_db_name</span> <span class="o">=</span> <span class="s">&#39;ckan_test_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">my_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_user</span> <span class="o">=</span> <span class="s">&#39;ckan_user_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">my_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_password</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="s">&#39;ckan_test_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">my_id</span><span class="p">)</span>

        <span class="c">## Make sure the configuration directory is there</span>
        <span class="n">conf_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">conf_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">conf_dir</span><span class="p">)</span>

        <span class="c">## Create a configuration file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_paster</span><span class="p">(</span><span class="s">&#39;make-config&#39;</span><span class="p">,</span> <span class="s">&#39;ckan&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf_update</span><span class="p">({</span>
            <span class="s">&#39;server:main&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span>
                <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s">&#39;app:main&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;beaker.session.key&#39;</span><span class="p">:</span> <span class="s">&#39;beaker-session-key-here&#39;</span><span class="p">,</span>
                <span class="s">&#39;app_instance_uuid&#39;</span><span class="p">:</span> <span class="s">&#39;{00001111-2222-3333-4444-555566667777}&#39;</span><span class="p">,</span>
                <span class="s">&#39;sqlalchemy.url&#39;</span><span class="p">:</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunparse</span><span class="p">((</span>
                    <span class="s">&#39;postgresql&#39;</span><span class="p">,</span>
                    <span class="s">&#39;{0}:{1}@{2}:{3}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_password</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_port</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postgresql_db_name</span><span class="p">,</span>
                    <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
                <span class="p">)),</span>
                <span class="s">&#39;ckan.site_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span>
                <span class="s">&#39;solr_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">solr_url</span><span class="p">,</span>
                <span class="c">#&#39;ofs.impl&#39;: &#39;pairtree&#39;,</span>
                <span class="c">#&#39;ofs.storage_dir&#39;: &#39;&#39;,</span>
                <span class="s">&#39;ckan.storage_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">})</span>

        <span class="c">## Create database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_db_user</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_db</span><span class="p">()</span>

        <span class="c">## Make sure the Solr index is clear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush_solr_index</span><span class="p">()</span>

        <span class="c">## Initialize database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paster_db_init</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.teardown"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.teardown">[docs]</a>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :py:meth:`__del__` to cleanup things.</span>

<span class="sd">        It will:</span>

<span class="sd">        - drop PostgreSQL database</span>
<span class="sd">        - drop PostgreSQL user</span>
<span class="sd">        - flush solr index</span>
<span class="sd">        - remove configuration file</span>
<span class="sd">        - remove storage data (uploaded files)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_db_user</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush_solr_index</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conf_file_path</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanEnvironment.__del__"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanEnvironment.__del__">[docs]</a>    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call :py:meth:`teardown` on exit.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teardown</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="CkanServerWrapper"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanServerWrapper">[docs]</a><span class="k">class</span> <span class="nc">CkanServerWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="CkanServerWrapper.url"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanServerWrapper.url">[docs]</a>    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;http://{host}:{port}/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CkanServerWrapper.start"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanServerWrapper.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="c">## Wait for the server to come up</span>
        <span class="n">wait_net_service</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span>
</div>
<div class="viewcode-block" id="CkanServerWrapper.stop"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.CkanServerWrapper.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

</div>
<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s">&#39;session&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ckan_env"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.ckan_env">[docs]</a><span class="k">def</span> <span class="nf">ckan_env</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example usage::</span>

<span class="sd">        def test_example(ckan_env):</span>

<span class="sd">            with ckan_env.serve() as server:</span>
<span class="sd">                ## Now make the client connect to ``server.url``</span>

<span class="sd">                ## If you need an API key:</span>
<span class="sd">                api_key = ckan_env.get_sysadmin_api_key()</span>
<span class="sd">                pass</span>


<span class="sd">    :return: A configured Ckan environment object, ready for use</span>
<span class="sd">    :rtype: :py:class:`CkanEnvironment`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CkanEnvironment</span><span class="o">.</span><span class="n">from_environment</span><span class="p">()</span>

</div>
<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s">&#39;module&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ckan_url"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.ckan_url">[docs]</a><span class="k">def</span> <span class="nf">ckan_url</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ckan_env</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create &amp; launch a Ckan instance; return a URL at which</span>
<span class="sd">    it is accessible.</span>

<span class="sd">    Note this would only work for read-only access, as there is no</span>
<span class="sd">    way to get an authentication key too..</span>

<span class="sd">    :return: URL to access the instance</span>
<span class="sd">    :rtype: basestring</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># todo: pass user:apikey in the url? -&gt; but it needs to be stripped..</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">ckan_env</span><span class="o">.</span><span class="n">serve</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">finalize</span><span class="p">():</span>
        <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">finalize</span><span class="p">)</span>

    <span class="n">base_url</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">url</span>

    <span class="k">def</span> <span class="nf">get_ckan_url</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">get_ckan_url</span>

</div>
<span class="nd">@pytest.fixture</span>
<div class="viewcode-block" id="data_dir"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.data_dir">[docs]</a><span class="k">def</span> <span class="nf">data_dir</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return path to the data directory.</span>

<span class="sd">    :rtype: :py:class:`py.path.local`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">py</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">here</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;data&#39;</span><span class="p">)</span>


<span class="c">##------------------------------------------------------------</span>
<span class="c">## Clients</span>
</div>
<span class="k">def</span> <span class="nf">_get_ckan_client</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ckan_env</span><span class="p">,</span> <span class="n">client_class</span><span class="p">):</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">ckan_env</span><span class="o">.</span><span class="n">get_sysadmin_api_key</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">ckan_env</span><span class="o">.</span><span class="n">serve</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">client_class</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finalize</span><span class="p">():</span>
        <span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">finalize</span><span class="p">)</span>

    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">client</span>


<span class="nd">@pytest.fixture</span>
<div class="viewcode-block" id="ckan_client_ll"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.ckan_client_ll">[docs]</a><span class="k">def</span> <span class="nf">ckan_client_ll</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ckan_env</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ckan_api_client.low_level</span> <span class="kn">import</span> <span class="n">CkanLowlevelClient</span>
    <span class="k">return</span> <span class="n">_get_ckan_client</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ckan_env</span><span class="p">,</span> <span class="n">CkanLowlevelClient</span><span class="p">)</span>

</div>
<span class="nd">@pytest.fixture</span>
<div class="viewcode-block" id="ckan_client_hl"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.ckan_client_hl">[docs]</a><span class="k">def</span> <span class="nf">ckan_client_hl</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ckan_env</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ckan_api_client.high_level</span> <span class="kn">import</span> <span class="n">CkanHighlevelClient</span>
    <span class="k">return</span> <span class="n">_get_ckan_client</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ckan_env</span><span class="p">,</span> <span class="n">CkanHighlevelClient</span><span class="p">)</span>

</div>
<span class="nd">@pytest.fixture</span>
<div class="viewcode-block" id="ckan_client_sync"><a class="viewcode-back" href="../../../testing/fixtures.html#ckan_api_client.tests.conftest.ckan_client_sync">[docs]</a><span class="k">def</span> <span class="nf">ckan_client_sync</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ckan_env</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ckan_api_client.syncing</span> <span class="kn">import</span> <span class="n">SynchronizationClient</span>
    <span class="k">return</span> <span class="n">_get_ckan_client</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ckan_env</span><span class="p">,</span> <span class="n">SynchronizationClient</span><span class="p">)</span>


<span class="c">##------------------------------------------------------------</span>
<span class="c">## More utilities</span>
</div>
<span class="k">def</span> <span class="nf">diff_eq</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">_pytest.assertion.util</span> <span class="kn">import</span> <span class="n">assertrepr_compare</span>
    <span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">config</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">assertrepr_compare</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&#39;==&#39;</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>

          <footer>
  

  <hr/>

  <p>
      &copy; Copyright 2014, Samuele Santi.
  </p>

  <a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>